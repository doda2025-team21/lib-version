name: Release lib-version

on:
  release:
    types: [published]
    
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g. v1.2.3)'
        required: true

permissions:
  contents: write
  packages: write
  
jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
          ref: main # change in main

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # - name: Show tag and pom version (debug)
      #   run: |
      #     echo "Tag is: $GITHUB_REF_NAME"
      #     echo "POM version is: $(mvn -q -Dexpression=project.version -DforceStdout help:evaluate)"

      - name: Determine release version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Triggered by workflow_dispatch"
            TAG_NAME="${{ github.event.inputs.release_version }}"
            echo "Workflow dispatch tag name: $TAG_NAME"
            VERSION="${TAG_NAME#v}"
            echo "Version from input: $VERSION"
          else
            echo "Triggered by release event"
            TAG_NAME="${{ github.event.release.tag_name }}"
            echo "Release tag name: $TAG_NAME"

            VERSION="${TAG_NAME#v}"
          fi

          echo "Release version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Set pom.xml version to release version
        run: |
          mvn -B versions:set -DnewVersion=${VERSION}
          mvn -B versions:commit
      
      # - name: Show current version (debug)
      #   run: |
      #     mvn -q -Dexpression=project.version -DforceStdout help:evaluate

      - name: Commit release version and create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add files where the version is stored
          git add pom.xml src/main/resources/version.properties

          # Create a commit with the release version
          git commit -m "Release ${VERSION}"

          # Create a tag that matches the version
          # if this is workflow_dispatch, tag it
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            git tag "v${VERSION}"
          fi

          # Push commit and tag
          git push origin main
          git push origin "v${VERSION}"
      
      - name: Deploy stable release to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: mvn -B clean deploy


      - name: Compute next SNAPSHOT version
        id: next_version
        run: |
          VERSION="${VERSION}"

          IFS='.' read -r major minor patch <<< "${VERSION}"
          next_patch=$((patch + 1))
          NEXT_VERSION="${major}.${minor}.${next_patch}-SNAPSHOT"

          echo "Next snapshot version: $NEXT_VERSION"
          echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_ENV


      - name: Set pom.xml to next SNAPSHOT version
        run: |
          mvn -B versions:set -DnewVersion=${NEXT_VERSION}
          mvn -B versions:commit


      - name: Commit and push next SNAPSHOT version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add pom.xml src/main/resources/version.properties

          git commit -m "Bump version to ${NEXT_VERSION}" || echo "No changes to commit"

          # if something change then push
          if git diff --quiet origin/main...HEAD; then
            echo "Nothing to push"
          else
            git push origin HEAD:main
          fi
