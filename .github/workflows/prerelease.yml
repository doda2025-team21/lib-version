name: Pre-release lib-version (branches)

on:
  push:
    branches:
      - '**'           # 所有分支
    tags: []

permissions:
  contents: read
  packages: write

jobs:
  prerelease:
    runs-on: ubuntu-latest

    # 不在 main 上跑预发布（你也可以改成只在某些分支跑）
    if: github.ref != 'refs/heads/main'

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Determine base version from pom.xml
        id: base_version
        run: |
          mvn versions:set -DremoveSnapshot
          BASE_VERSION=$(mvn -q -Dexpression=project.version -DforceStdout help:evaluate)
          echo "BASE_VERSION=$BASE_VERSION" >> $GITHUB_ENV
          echo "Base version: $BASE_VERSION"
    
        #BASE_NO_SNAPSHOT is not used yet. TEST mvn versions:set -DremoveSnapshot first
      - name: Strip SNAPSHOT suffix
        id: strip_snapshot
        run: |
          mvn versions:set -DremoveSnapshot
          BASE_VERSION_RAW="${BASE_VERSION_RAW}"

          # remove trailing "-SNAPSHOT" if it exists
          BASE_NO_SNAPSHOT="${BASE_VERSION_RAW%-SNAPSHOT}"

          echo "Base version without SNAPSHOT: $BASE_NO_SNAPSHOT"
          echo "BASE_NO_SNAPSHOT=$BASE_NO_SNAPSHOT" >> $GITHUB_ENV

      - name: Create pre-release version string
        id: prerelease
        run: |
          # branch name like: feature/new-api -> feature-new-api
          BRANCH_RAW="${GITHUB_REF_NAME}"
          BRANCH_CLEAN=$(echo "$BRANCH_RAW" | tr '/' '-')

          TIMESTAMP=$(date +'%y%m%d-%H%M%S')

          PRE_VERSION="${BASE_VERSION}-${BRANCH_CLEAN}-${TIMESTAMP}"

          echo "Pre-release version: $PRE_VERSION"
          echo "PRE_VERSION=$PRE_VERSION" >> $GITHUB_ENV

      - name: Set pom.xml to pre-release version
        run: |
          mvn -B versions:set -DnewVersion=${PRE_VERSION}
          mvn -B versions:commit

      - name: Deploy pre-release to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: mvn -B clean deploy